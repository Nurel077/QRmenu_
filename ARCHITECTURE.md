# Архитектура проекта RestaurantQR

## Обзор системы

RestaurantQR - это полнофункциональная система управления заказами в ресторанах через QR-меню. Система построена на Django и использует многоприложенческую архитектуру.

## Диаграмма потока данных

```
┌─────────────┐
│   Гость     │ 
│ (сканирует  │ 
│  QR код)    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────┐
│  Table (Столик)             │
│  - QR код с уникальным URL  │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│  TableSession (Сессия)       │
│  - Код для подключения       │
│  - Время начала/окончания    │
└──────┬───────────────────────┘
       │
       ├─► ┌──────────────────────┐
       │   │  GuestSession        │
       │   │  (Сессия гостя 1)    │
       │   └──────────────────────┘
       │
       └─► ┌──────────────────────┐
           │  GuestSession        │
           │  (Сессия гостя 2)    │
           └──────┬───────────────┘
                  │
                  ▼
           ┌────────────────┐
           │  Order (Заказ) │
           │  - Позиции     │
           │  - Статус      │
           │  - Оплата      │
           └────────┬───────┘
                    │
                    ▼
           ┌─────────────────┐
           │  OrderItem      │
           │  (Позиция)      │
           └─────────────────┘
```

## Структура приложений

### 1. accounts (Пользователи и аутентификация)

**Модели:**
- `User` - Кастомная модель пользователя с ролями
  - SUPERADMIN - Администратор системы
  - OWNER - Владелец ресторана
  - WAITER - Официант
  - GUEST - Гость (опционально)

- `GuestSession` - Сессии неавторизованных гостей

**Основные функции:**
- Управление пользователями
- Аутентификация и авторизация
- Разграничение прав доступа по ролям
- Отслеживание сессий гостей

### 2. restaurants (Рестораны)

**Модели:**
- `Restaurant` - Основная модель ресторана
  - Основная информация (название, адрес, контакты)
  - Настройки (валюта, язык, налоги)
  - Время работы
  - Настройки оплаты

- `RestaurantSettings` - Расширенные настройки
  - Уведомления
  - Оформление (цвета)
  - Кастомные тексты

**Основные функции:**
- Управление информацией о ресторане
- Настройка внешнего вида меню
- Конфигурация способов оплаты

### 3. tables (Столики)

**Модели:**
- `Table` - Столик в ресторане
  - Номер и вместимость
  - QR код
  - Статус (занят/свободен)
  - Зона размещения

- `TableSession` - Активная сессия за столиком
  - Код сессии для подключения
  - Время начала/окончания
  - Привязанный официант

**Основные функции:**
- Генерация уникальных QR кодов
- Управление сессиями столиков
- Отслеживание занятости

### 4. menu (Меню)

**Модели:**
- `MenuCategory` - Категория меню
  - Название и описание
  - Порядок сортировки
  - Иконка

- `MenuItem` - Позиция в меню (блюдо)
  - Основная информация
  - Цена
  - Характеристики (вегетарианское, острое и т.д.)
  - Наличие на складе
  - Фото

- `MenuItemOption` - Опции для блюд
  - Размеры
  - Дополнения
  - Модификаторы цены

**Основные функции:**
- Управление категориями и блюдами
- Отслеживание наличия
- Настройка опций блюд

### 5. orders (Заказы)

**Модели:**
- `Order` - Заказ
  - Привязка к сессии столика
  - Привязка к гостю
  - Статус (pending → confirmed → preparing → ready → delivered → paid)
  - Способ оплаты
  - Временные метки

- `OrderItem` - Позиция в заказе
  - Блюдо
  - Количество
  - Цена (фиксированная на момент заказа)
  - Выбранные опции
  - Примечания

- `OrderStatusHistory` - История изменений статуса

**Основные функции:**
- Создание заказов гостями
- Подтверждение заказов официантами
- Отслеживание статусов
- Расчет суммы с налогами

### 6. payments (Платежи)

**Модели:**
- `Payment` - Платеж
  - Привязка к заказу или сессии
  - Тип (наличные/QR/карта)
  - Статус
  - Сумма и валюта
  - Данные транзакции

- `QRPaymentCode` - QR коды для оплаты
  - Генерация QR
  - Срок действия

**Основные функции:**
- Обработка различных типов оплаты
- Генерация QR кодов для оплаты
- Возврат средств
- История платежей

## Потоки работы (User Flows)

### Поток гостя:

1. **Сканирование QR кода**
   - Гость сканирует QR код столика
   - Система открывает URL столика

2. **Подключение к столику**
   - Проверка активной сессии столика
   - Создание или присоединение к `TableSession`
   - Создание `GuestSession` для гостя

3. **Просмотр меню**
   - Отображение категорий и блюд
   - Фильтрация по характеристикам
   - Просмотр деталей блюд

4. **Создание заказа**
   - Выбор блюд и опций
   - Добавление примечаний
   - Выбор способа оплаты
   - Создание `Order` со статусом PENDING

5. **Отслеживание заказа**
   - WebSocket подключение для real-time обновлений
   - Просмотр статуса заказа

6. **Оплата**
   - Наличные: ожидание подтверждения официанта
   - QR: сканирование кода и оплата

### Поток официанта:

1. **Начало смены**
   - Вход в систему
   - Установка статуса "на смене"

2. **Обслуживание столиков**
   - Просмотр активных столиков
   - Присвоение себе столиков

3. **Обработка заказов**
   - Получение уведомлений о новых заказах
   - Подтверждение заказов (для наличных)
   - Изменение статусов (preparing → ready → delivered)

4. **Прием оплаты**
   - Подтверждение наличной оплаты
   - Создание `Payment` записи
   - Закрытие заказов

5. **Завершение сессии**
   - Закрытие `TableSession`
   - Освобождение столика

### Поток владельца:

1. **Управление рестораном**
   - Редактирование информации
   - Настройка параметров

2. **Управление меню**
   - Создание категорий
   - Добавление/редактирование блюд
   - Установка цен
   - Управление наличием

3. **Управление столиками**
   - Добавление столиков
   - Генерация QR кодов
   - Распечатка QR кодов

4. **Управление персоналом**
   - Добавление официантов
   - Назначение прав

5. **Просмотр аналитики**
   - Статистика заказов
   - Популярные блюда
   - Выручка

## Интеграции

### WebSockets (Django Channels)

Используется для:
- Обновления статусов заказов в реальном времени
- Уведомления официантов о новых заказах
- Синхронизация между гостями за одним столом

**Каналы:**
- `order_updates_{order_id}` - обновления конкретного заказа
- `table_{table_id}` - обновления столика
- `waiter_{user_id}` - уведомления официанта

### REST API

Основные эндпоинты:
- `/api/restaurants/` - CRUD ресторанов
- `/api/tables/` - CRUD столиков
- `/api/menu/` - CRUD меню
- `/api/orders/` - Управление заказами
- `/api/payments/` - Обработка платежей

## Безопасность

### Разграничение доступа:

1. **SuperAdmin**
   - Полный доступ ко всем ресторанам
   - Управление пользователями

2. **Owner**
   - Доступ только к своему ресторану
   - Управление меню и столиками
   - Просмотр статистики

3. **Waiter**
   - Доступ только к своему ресторану
   - Управление заказами
   - Подтверждение платежей

4. **Guest**
   - Только просмотр меню
   - Создание заказов
   - Просмотр своих заказов

### Защита данных:

- CSRF токены для форм
- JWT для API аутентификации
- Валидация входных данных
- Ограничение rate-limit
- Безопасные sessions для гостей

## Масштабирование

### Горизонтальное масштабирование:

- Статические файлы через CDN (WhiteNoise)
- Media файлы в облачном хранилище (S3)
- Redis для sessions и channels
- PostgreSQL с репликацией
- Load balancer (nginx)

### Оптимизация:

- Кэширование меню (Redis)
- Select related/prefetch для запросов
- Индексы на часто запрашиваемые поля
- Lazy loading изображений
- Минификация CSS/JS

## Мониторинг и логирование

- Логи Django в файлы
- Sentry для отслеживания ошибок (опционально)
- Мониторинг производительности
- Алерты при критических ошибках

## Будущие улучшения

1. **Мобильное приложение**
   - Native iOS/Android
   - React Native

2. **Расширенная аналитика**
   - Дашборды для владельцев
   - Прогнозирование спроса
   - ABC анализ блюд

3. **Интеграция с кухней**
   - KDS (Kitchen Display System)
   - Принтеры заказов

4. **Программа лояльности**
   - Накопительные баллы
   - Скидки

5. **Бронирование**
   - Онлайн бронь столиков
   - Календарь бронирований

6. **Мультиязычность**
   - Django i18n
   - Переключение языков в меню
